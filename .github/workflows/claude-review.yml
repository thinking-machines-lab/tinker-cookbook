name: claude-code-review

# These permissions are required for Claude Code to:
# - read repo contents
# - comment on PRs/issues
# - access CI status
# - obtain an OIDC token (used internally by the action)
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

# Triggers:
# - pull_request: auto-review on open/update/reopen
# - issue_comment + pull_request_review_comment: respond to @claude mentions
on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Global env for the workflow.
# We set ANTHROPIC_API_KEY once here, then re-use it in both jobs.
# NOTE: GitHub does NOT expose secrets to workflows triggered from forks;
# in those runs this will be empty and the jobs will fail (by design).
env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # --------------------------
  # Job 1: Automated PR review
  # --------------------------
  claude_auto_review:
    runs-on: ubuntu-latest
    environment: claude-review

    # Only run this job for pull_request events.
    if: github.event_name == 'pull_request'

    steps:
      # Each job runs in a fresh VM, so we must checkout in every job.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 0 = fetch full history (sometimes useful for diff-based tools)
          # 1 is usually enough; use 0 if you run into history-related issues.
          fetch-depth: 1

      - name: Run Claude Code auto review
        uses: anthropics/claude-code-action@v1
        with:
          # The action accepts the API key as an input; we source it from env
          # so it's defined once at the top of the workflow.
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}

          # Built-in slash command that performs a full PR review.
          prompt: "/review"

          # Limit how long Claude iterates on the review.
          # You can tune this for speed vs. depth.
          claude_args: "--max-turns 5"

  # ---------------------------------------
  # Job 2: Comment-triggered @claude runs
  # ---------------------------------------
  claude_comment_trigger:
    runs-on: ubuntu-latest
    environment: claude-review

    # Only run when:
    #   - the event is a comment (issue or PR review), AND
    #   - the comment body contains "@claude"
    #
    # Parentheses matter here: we want
    #   (issue_comment OR pull_request_review_comment) AND contains(...)
    if: >
      (github.event_name == 'issue_comment' ||
       github.event_name == 'pull_request_review_comment')
      && contains(github.event.comment.body, '@claude')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code on @claude comment
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ env.ANTHROPIC_API_KEY }}

          # No explicit prompt here: by default the action will respond
          # in the thread where @claude was mentioned, using the comment
          # as the "instruction".
